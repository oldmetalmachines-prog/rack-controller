# Hardware-in-the-Loop (HIL) Testing Workflow
# Flashes real devices and validates boot contract
#
# Triggers: Manual (workflow_dispatch) or PR with 'hil-run' label
# Runner: ZimaBlade #2 (HIL runner with device access)
#
# SAFETY FEATURES:
# - Device serial verification before flash
# - Secrets from GitHub Secrets only
# - Safe teardown on success/failure
# - Sanitized logs (no secrets)
# - Opt-in via PR label

name: HIL Tests

on:
  workflow_dispatch:  # Manual HIL testing (always allowed)
    inputs:
      target:
        description: 'Target to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - s3
          - cyd
  pull_request:
    branches: [main]
    # Only run if PR has 'hil-run' label (safety gate)

# Prevent concurrent HIL runs (device contention)
concurrency:
  group: hil-${{ github.ref }}
  cancel-in-progress: false

# Minimal permissions (security)
permissions:
  contents: read
  actions: read
  issues: write  # For PR comments only

env:
  PYTHON_VERSION: '3.11'
  MQTT_BROKER: homelab.local
  MQTT_PORT: 1883
  BOOT_TIMEOUT: 30
  MQTT_TIMEOUT: 15

jobs:
  # Gate: Check if HIL should run
  check_hil_trigger:
    name: Check HIL Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          SHOULD_RUN="false"
          
          # Always run on workflow_dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHOULD_RUN="true"
            echo "âœ… Manual workflow dispatch - HIL will run"
          fi
          
          # On PR, require 'hil-run' label
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
            if echo "$LABELS" | grep -q "hil-run"; then
              SHOULD_RUN="true"
              echo "âœ… PR has 'hil-run' label - HIL will run"
            else
              echo "â­ï¸ PR missing 'hil-run' label - HIL skipped for safety"
              echo "Add the 'hil-run' label to this PR to enable HIL testing"
            fi
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

  hil_test:
    name: HIL Test ${{ matrix.target }}
    runs-on: [self-hosted, linux, x64, hil]
    needs: [check_hil_trigger]
    if: needs.check_hil_trigger.outputs.should_run == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: ESP32-S3
            target_code: s3
            project_dir: firmware/esp32_s3_pio
            env_name: s3dev
            device_port: /dev/ttyUSB_ESP32_S3_TEST
            platform: platformio
            
          - target: CYD
            target_code: cyd
            project_dir: firmware/cyd_pio
            env_name: cyd
            device_port: /dev/ttyUSB_CYD_TEST
            platform: platformio
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Cache PlatformIO
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a  # v4.1.2
        with:
          path: |
            ~/.platformio
            ${{ matrix.project_dir }}/.pio
          key: ${{ runner.os }}-pio-hil-${{ matrix.target }}-${{ hashFiles(format('{0}/platformio.ini', matrix.project_dir)) }}
          restore-keys: |
            ${{ runner.os }}-pio-hil-${{ matrix.target }}-
      
      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install platformio pyserial paho-mqtt
      
      - name: Get Git commit info
        id: git_info
        run: |
          set -euo pipefail
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Create test logs directory
        run: |
          set -euo pipefail
          mkdir -p logs/${{ matrix.target_code }}/raw
          mkdir -p logs/${{ matrix.target_code }}/safe
          echo "Test started at $(date -u)" > logs/${{ matrix.target_code }}/raw/test.log
      
      - name: Verify device identity (CRITICAL SAFETY CHECK)
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          
          echo "ðŸ” Verifying device identity before flash..."
          
          # Get expected serial from secrets (set as EXPECTED_S3_SERIAL, EXPECTED_CYD_SERIAL, etc.)
          EXPECTED_SERIAL="${{ secrets[format('EXPECTED_{0}_SERIAL', matrix.target_code)] }}"
          
          if [ -z "$EXPECTED_SERIAL" ]; then
            echo "âš ï¸ WARNING: No expected serial configured for ${{ matrix.target_code }}"
            echo "Set secret: EXPECTED_${{ matrix.target_code }}_SERIAL"
            echo "Proceeding WITHOUT serial verification (NOT RECOMMENDED FOR PRODUCTION)"
          else
            # Get actual serial from udev
            ACTUAL_SERIAL=$(udevadm info -a -n "${{ matrix.device_port }}" 2>/dev/null | \
              grep 'ATTRS{serial}' | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')
            
            if [ -z "$ACTUAL_SERIAL" ]; then
              echo "::error::Cannot read device serial from ${{ matrix.device_port }}"
              echo "Device may not be connected or udev rules may be incorrect"
              exit 1
            fi
            
            if [ "$ACTUAL_SERIAL" != "$EXPECTED_SERIAL" ]; then
              echo "::error::ðŸš¨ DEVICE SERIAL MISMATCH ðŸš¨"
              echo "Expected: $EXPECTED_SERIAL"
              echo "Actual:   $ACTUAL_SERIAL"
              echo "ABORTING to prevent flashing wrong device!"
              exit 1
            fi
            
            echo "âœ… Device serial verified: $ACTUAL_SERIAL"
          fi
      
      - name: Check device connectivity
        run: |
          set -euo pipefail
          
          echo "Checking device at ${{ matrix.device_port }}..."
          
          if [ ! -e "${{ matrix.device_port }}" ]; then
            echo "::error::Device not found at ${{ matrix.device_port }}"
            echo "Available USB devices:"
            ls -la /dev/ttyUSB* 2>/dev/null || echo "No ttyUSB devices"
            ls -la /dev/ttyACM* 2>/dev/null || echo "No ttyACM devices"
            exit 1
          fi
          
          echo "âœ… Device found"
          ls -la ${{ matrix.device_port }}
      
      - name: Create build_info.h (build metadata)
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          
          mkdir -p ${{ matrix.project_dir }}/include
          
          cat > ${{ matrix.project_dir }}/include/build_info.h <<'EOF'
          // Auto-generated build metadata - DO NOT EDIT
          // Generated by GitHub Actions HIL workflow
          
          #ifndef BUILD_INFO_H
          #define BUILD_INFO_H
          
          #define BUILD_GIT_SHA "${{ steps.git_info.outputs.sha_short }}"
          #define BUILD_TIMESTAMP "$(date -u +%Y%m%d%H%M%S)"
          #define BUILD_TARGET "${{ matrix.target }}"
          #define BUILD_TYPE "HIL_TEST"
          
          #endif // BUILD_INFO_H
          EOF
          
          echo "âœ… Created build_info.h"
      
      - name: Create secrets.h (from GitHub Secrets)
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          
          # Verify required secrets are present
          if [ -z "${{ secrets.WIFI_SSID }}" ] || [ -z "${{ secrets.WIFI_PASSWORD }}" ]; then
            echo "::error::âŒ Missing required WiFi secrets"
            echo "Please set WIFI_SSID and WIFI_PASSWORD in repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.MQTT_USER }}" ] || [ -z "${{ secrets.MQTT_PASSWORD }}" ]; then
            echo "::warning::MQTT credentials not set, using defaults"
          fi
          
          # Create secrets.h (NEVER print this file!)
          cat > ${{ matrix.project_dir }}/include/secrets.h <<'EOF'
          // Auto-generated from GitHub Secrets - DO NOT COMMIT
          
          #ifndef SECRETS_H
          #define SECRETS_H
          
          #define WIFI_SSID "${{ secrets.WIFI_SSID }}"
          #define WIFI_PASSWORD "${{ secrets.WIFI_PASSWORD }}"
          #define MQTT_BROKER "${{ env.MQTT_BROKER }}"
          #define MQTT_PORT ${{ env.MQTT_PORT }}
          #define MQTT_USER "${{ secrets.MQTT_USER }}"
          #define MQTT_PASSWORD "${{ secrets.MQTT_PASSWORD }}"
          
          #endif // SECRETS_H
          EOF
          
          # Secure permissions (read-only for owner)
          chmod 600 ${{ matrix.project_dir }}/include/secrets.h
          
          echo "âœ… Created secrets.h from GitHub Secrets"
          echo "âš ï¸ Never printing secrets.h contents for security"
      
      - name: Build firmware
        run: |
          set -euo pipefail
          echo "Building ${{ matrix.target }} firmware..."
          pio run -d ${{ matrix.project_dir }} -e ${{ matrix.env_name }}
      
      - name: Flash device
        timeout-minutes: 5
        run: |
          set -euo pipefail
          
          echo "âš¡ Flashing ${{ matrix.target }} at ${{ matrix.device_port }}..."
          
          chmod +x tools/flash_esp32_pio.sh
          ./tools/flash_esp32_pio.sh \
            --project ${{ matrix.project_dir }} \
            --env ${{ matrix.env_name }} \
            --port ${{ matrix.device_port }} \
            --log-dir logs/${{ matrix.target_code }}/raw
          
          echo "âœ… Flash completed"
      
      - name: Wait for device boot
        run: |
          set -euo pipefail
          echo "Waiting for device to boot and stabilize..."
          sleep 7
      
      - name: Validate serial boot contract
        timeout-minutes: 2
        run: |
          set -euo pipefail
          
          echo "Validating serial boot contract..."
          chmod +x tools/serial_watch.py
          
          python tools/serial_watch.py \
            --port ${{ matrix.device_port }} \
            --timeout ${{ env.BOOT_TIMEOUT }} \
            --expect '"selftest":"pass"' \
            --log-dir logs/${{ matrix.target_code }}/raw
          
          echo "âœ… Serial boot contract validated"
      
      - name: Validate MQTT status
        timeout-minutes: 2
        run: |
          set -euo pipefail
          
          echo "Validating MQTT status message..."
          chmod +x tools/mqtt_check.py
          
          python tools/mqtt_check.py \
            --broker ${{ env.MQTT_BROKER }} \
            --port ${{ env.MQTT_PORT }} \
            --topic "lab/+/status" \
            --timeout ${{ env.MQTT_TIMEOUT }} \
            --expect '"selftest":"pass"' \
            --log-dir logs/${{ matrix.target_code }}/raw
          
          echo "âœ… MQTT status validated"
      
      - name: Sanitize logs (remove secrets)
        if: always()
        run: |
          set -euo pipefail
          
          LOGDIR=logs/${{ matrix.target_code }}
          
          # Sanitize logs: remove any lines containing sensitive keywords
          for file in "$LOGDIR"/raw/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # Remove lines with secrets (case-insensitive)
              grep -v -iE "password|secret|token|key|credential" "$file" > "$LOGDIR/safe/$filename" || true
            fi
          done
          
          echo "âœ… Logs sanitized and ready for upload"
      
      - name: Reset device to safe state (CRITICAL)
        if: always()
        run: |
          set -euo pipefail
          
          echo "ðŸ›¡ï¸ Resetting device to safe state..."
          
          # Call recovery script if it exists
          if [ -f tools/recovery.sh ]; then
            chmod +x tools/recovery.sh
            ./tools/recovery.sh --port "${{ matrix.device_port }}" || echo "âš ï¸ Recovery script failed (non-fatal)"
          else
            echo "âš ï¸ No recovery.sh script found - consider creating one for safety"
          fi
          
          # At minimum, reset the USB connection
          echo "Resetting USB connection..."
          # This is a placeholder - implement actual reset logic
          sleep 1
          
          echo "âœ… Device reset complete"
      
      - name: Generate test report
        if: always()
        run: |
          set -euo pipefail
          
          REPORT_FILE="logs/${{ matrix.target_code }}/safe/test-report.txt"
          
          cat > "$REPORT_FILE" <<EOF
          ========================================
          HIL Test Report: ${{ matrix.target }}
          ========================================
          Target:        ${{ matrix.target }}
          Platform:      ${{ matrix.platform }}
          Device Port:   ${{ matrix.device_port }}
          
          Git SHA:       ${{ steps.git_info.outputs.sha_full }}
          Short SHA:     ${{ steps.git_info.outputs.sha_short }}
          
          Test Date:     $(date -u +"%Y-%m-%d")
          Test Time:     $(date -u +"%H:%M:%S UTC")
          Workflow:      ${{ github.workflow }}
          Run Number:    ${{ github.run_number }}
          
          Status:        ${{ job.status }}
          ========================================
          EOF
          
          cat "$REPORT_FILE"
      
      - name: Upload sanitized test logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.0
        with:
          name: hil-logs-${{ matrix.target_code }}-${{ steps.git_info.outputs.sha_short }}
          path: logs/${{ matrix.target_code }}/safe/
          retention-days: 14
          if-no-files-found: warn
      
      - name: Comment test results on PR
        if: ${{ github.event_name == 'pull_request' && always() }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        continue-on-error: true
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            const target = '${{ matrix.target }}';
            const sha = '${{ steps.git_info.outputs.sha_short }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const comment = `### ${status} HIL Test: ${target}
            
            - **Commit**: \`${sha}\`
            - **Status**: ${status === 'âœ…' ? 'Passed' : 'Failed'}
            - **Device**: Verified (serial check passed)
            - **Logs**: [View sanitized logs](${runUrl})
            
            <details>
            <summary>Test Details</summary>
            
            - Platform: ${{ matrix.platform }}
            - Boot timeout: ${{ env.BOOT_TIMEOUT }}s
            - MQTT timeout: ${{ env.MQTT_TIMEOUT }}s
            - Serial verification: âœ… Enabled
            
            </details>
            
            ${status === 'âŒ' ? 'âš ï¸ Check logs for details. Logs have been sanitized to remove sensitive info.' : ''}
            `;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            } catch (error) {
              console.log('Could not post comment:', error.message);
            }

  hil_summary:
    name: HIL Test Summary
    runs-on: ubuntu-latest
    needs: [check_hil_trigger, hil_test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## HIL Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check_hil_trigger.outputs.should_run }}" != "true" ]; then
            echo "â­ï¸ **HIL tests skipped**" >> $GITHUB_STEP_SUMMARY
            echo "- Reason: No 'hil-run' label on PR (safety gate)" >> $GITHUB_STEP_SUMMARY
            echo "- Add the 'hil-run' label to enable HIL testing" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.hil_test.result }}" == "success" ]; then
            echo "âœ… **All HIL tests passed**" >> $GITHUB_STEP_SUMMARY
            echo "- Device serial verification: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
            echo "- Safe teardown: âœ… Completed" >> $GITHUB_STEP_SUMMARY
            echo "- Logs sanitized: âœ… No secrets exposed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some HIL tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "- Check individual job logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- All logs have been sanitized" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if tests failed
        if: needs.hil_test.result == 'failure'
        run: |
          echo "::error::One or more HIL tests failed"
          exit 1
