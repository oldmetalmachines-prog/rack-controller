# Hardware-in-the-Loop (HIL) Testing Workflow
# Flashes real devices and validates boot contract
#
# Triggers: PR only
# Runner: ZimaBlade #2 (HIL runner with device access)

name: HIL Tests

on:
  pull_request:
    branches: [main]

# Environment variables for test devices
env:
  MQTT_BROKER: homelab.local
  MQTT_PORT: 1883
  # Device ports (update with actual udev symlinks)
  S3_TEST_PORT: /dev/ttyUSB_ESP32_S3_TEST
  CYD_TEST_PORT: /dev/ttyUSB_CYD_TEST
  P4_TEST_PORT: /dev/ttyUSB_P4_TEST

jobs:
  hil_flash_s3:
    name: HIL Test ESP32-S3
    runs-on: [self-hosted, linux, x64, hil]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install platformio pyserial paho-mqtt
      
      - name: Create secrets.h
        run: |
          cp firmware/esp32_s3_pio/include/secrets.h.template \
             firmware/esp32_s3_pio/include/secrets.h
          # TODO: Inject test credentials via secrets
          # sed -i 's/your-ssid-here/${{ secrets.TEST_WIFI_SSID }}/g' ...
      
      - name: Flash ESP32-S3
        run: |
          chmod +x tools/flash_esp32_pio.sh
          ./tools/flash_esp32_pio.sh \
            --project firmware/esp32_s3_pio \
            --env s3dev \
            --port ${{ env.S3_TEST_PORT }} \
            --log-dir logs/s3
      
      - name: Wait for device boot
        run: sleep 5
      
      - name: Validate serial boot contract
        run: |
          chmod +x tools/serial_watch.py
          python tools/serial_watch.py \
            --port ${{ env.S3_TEST_PORT }} \
            --timeout 30 \
            --expect '"selftest":"pass"' \
            --log-dir logs/s3
      
      - name: Validate MQTT status
        run: |
          chmod +x tools/mqtt_check.py
          python tools/mqtt_check.py \
            --broker ${{ env.MQTT_BROKER }} \
            --port ${{ env.MQTT_PORT }} \
            --topic "lab/+/status" \
            --timeout 15 \
            --expect '"selftest":"pass"' \
            --log-dir logs/s3
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs-s3
          path: logs/s3/
          retention-days: 7

  hil_flash_cyd:
    name: HIL Test CYD
    runs-on: [self-hosted, linux, x64, hil]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install platformio pyserial paho-mqtt
      
      - name: Create secrets.h
        run: |
          cp firmware/cyd_pio/include/secrets.h.template \
             firmware/cyd_pio/include/secrets.h
      
      - name: Flash CYD
        run: |
          chmod +x tools/flash_esp32_pio.sh
          ./tools/flash_esp32_pio.sh \
            --project firmware/cyd_pio \
            --env cyd \
            --port ${{ env.CYD_TEST_PORT }} \
            --log-dir logs/cyd
      
      - name: Wait for device boot
        run: sleep 5
      
      - name: Validate serial boot contract
        run: |
          python tools/serial_watch.py \
            --port ${{ env.CYD_TEST_PORT }} \
            --timeout 30 \
            --expect '"selftest":"pass"' \
            --log-dir logs/cyd
      
      - name: Validate MQTT status
        run: |
          python tools/mqtt_check.py \
            --broker ${{ env.MQTT_BROKER }} \
            --port ${{ env.MQTT_PORT }} \
            --topic "lab/+/status" \
            --timeout 15 \
            --expect '"selftest":"pass"' \
            --log-dir logs/cyd
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs-cyd
          path: logs/cyd/
          retention-days: 7

  hil_flash_p4:
    name: HIL Test ESP32-P4
    runs-on: [self-hosted, linux, x64, hil]
    # Skip until P4 hardware is available
    if: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up ESP-IDF
        run: source $IDF_PATH/export.sh
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pyserial paho-mqtt
      
      - name: Flash ESP32-P4
        run: |
          chmod +x tools/flash_esp32_idf.sh
          ./tools/flash_esp32_idf.sh \
            --project firmware/esp32_p4_idf \
            --port ${{ env.P4_TEST_PORT }} \
            --log-dir logs/p4
      
      - name: Wait for device boot
        run: sleep 5
      
      - name: Validate serial boot contract
        run: |
          python tools/serial_watch.py \
            --port ${{ env.P4_TEST_PORT }} \
            --timeout 30 \
            --expect '"selftest":"pass"' \
            --log-dir logs/p4
      
      - name: Validate MQTT status
        run: |
          python tools/mqtt_check.py \
            --broker ${{ env.MQTT_BROKER }} \
            --port ${{ env.MQTT_PORT }} \
            --topic "lab/+/status" \
            --timeout 15 \
            --expect '"selftest":"pass"' \
            --log-dir logs/p4
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs-p4
          path: logs/p4/
          retention-days: 7
