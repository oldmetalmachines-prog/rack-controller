# Hardware-in-the-Loop (HIL) Testing Workflow
# Flashes real devices and validates boot contract
#
# Triggers: PR only (and workflow_dispatch for manual testing)
# Runner: ZimaBlade #2 (HIL runner with device access)

name: HIL Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual HIL testing
    inputs:
      target:
        description: 'Target to test (s3, cyd, p4, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - s3
          - cyd
          - p4

env:
  PYTHON_VERSION: '3.11'
  MQTT_BROKER: homelab.local
  MQTT_PORT: 1883
  BOOT_TIMEOUT: 30
  MQTT_TIMEOUT: 15

jobs:
  hil_test:
    name: HIL Test ${{ matrix.target }}
    runs-on: [self-hosted, linux, x64, hil]
    
    # Skip based on workflow_dispatch input or platform availability
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == matrix.target_code))
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: ESP32-S3
            target_code: s3
            project_dir: firmware/esp32_s3_pio
            env_name: s3dev
            port_env: S3_TEST_PORT
            device_port: /dev/ttyUSB_ESP32_S3_TEST
            platform: platformio
            enabled: true
            
          - target: CYD
            target_code: cyd
            project_dir: firmware/cyd_pio
            env_name: cyd
            port_env: CYD_TEST_PORT
            device_port: /dev/ttyUSB_CYD_TEST
            platform: platformio
            enabled: true
            
          - target: ESP32-P4
            target_code: p4
            project_dir: firmware/esp32_p4_idf
            env_name: p4
            port_env: P4_TEST_PORT
            device_port: /dev/ttyUSB_P4_TEST
            platform: idf
            enabled: false  # Not yet available
    
    # Skip disabled targets
    continue-on-error: ${{ !matrix.enabled }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Cache PlatformIO
        if: matrix.platform == 'platformio'
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ${{ matrix.project_dir }}/.pio
          key: ${{ runner.os }}-pio-hil-${{ matrix.target }}-${{ hashFiles(format('{0}/platformio.ini', matrix.project_dir)) }}
          restore-keys: |
            ${{ runner.os }}-pio-hil-${{ matrix.target }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          if [ "${{ matrix.platform }}" == "platformio" ]; then
            pip install platformio pyserial paho-mqtt
          else
            pip install pyserial paho-mqtt
          fi
      
      - name: Get Git commit info
        id: git_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Create test logs directory
        run: |
          mkdir -p logs/${{ matrix.target_code }}
          echo "Test started at $(date -u)" > logs/${{ matrix.target_code }}/test.log
      
      - name: Check device connectivity
        run: |
          echo "Checking for device at ${{ matrix.device_port }}..."
          
          if [ ! -e "${{ matrix.device_port }}" ]; then
            echo "::warning::Device not found at ${{ matrix.device_port }}"
            echo "Available USB devices:"
            ls -la /dev/ttyUSB* 2>/dev/null || echo "No ttyUSB devices found"
            ls -la /dev/ttyACM* 2>/dev/null || echo "No ttyACM devices found"
            
            # Don't fail immediately - flash step will fail if device truly unavailable
          else
            echo "✅ Device found at ${{ matrix.device_port }}"
            ls -la ${{ matrix.device_port }}
          fi
      
      - name: Create secrets.h from template
        if: matrix.platform == 'platformio'
        run: |
          cp ${{ matrix.project_dir }}/include/secrets.h.template \
             ${{ matrix.project_dir }}/include/secrets.h
          
          # Inject test credentials if available
          # NOTE: Add these as repository secrets for actual testing
          # if [ -n "${{ secrets.TEST_WIFI_SSID }}" ]; then
          #   sed -i 's/your-ssid-here/${{ secrets.TEST_WIFI_SSID }}/g' \
          #     ${{ matrix.project_dir }}/include/secrets.h
          # fi
          
          # Inject build metadata
          cat >> ${{ matrix.project_dir }}/include/secrets.h << EOF
          
          // HIL Test Build
          #define BUILD_GIT_SHA "${{ steps.git_info.outputs.sha_short }}"
          #define BUILD_TIMESTAMP $(date +%s)
          #define BUILD_TARGET "${{ matrix.target }}"
          EOF
      
      - name: Build firmware (PlatformIO)
        if: matrix.platform == 'platformio'
        run: |
          echo "Building ${{ matrix.target }} firmware..."
          pio run -d ${{ matrix.project_dir }} -e ${{ matrix.env_name }}
      
      - name: Build firmware (ESP-IDF)
        if: matrix.platform == 'idf'
        run: |
          echo "Building ${{ matrix.target }} firmware..."
          . $IDF_PATH/export.sh
          cd ${{ matrix.project_dir }}
          idf.py set-target esp32p4
          idf.py build
      
      - name: Flash device (PlatformIO)
        if: matrix.platform == 'platformio'
        timeout-minutes: 5
        run: |
          echo "Flashing ${{ matrix.target }} at ${{ matrix.device_port }}..."
          
          chmod +x tools/flash_esp32_pio.sh
          ./tools/flash_esp32_pio.sh \
            --project ${{ matrix.project_dir }} \
            --env ${{ matrix.env_name }} \
            --port ${{ matrix.device_port }} \
            --log-dir logs/${{ matrix.target_code }} \
            || (echo "::error::Flash failed for ${{ matrix.target }}" && exit 1)
      
      - name: Flash device (ESP-IDF)
        if: matrix.platform == 'idf'
        timeout-minutes: 5
        run: |
          echo "Flashing ${{ matrix.target }} at ${{ matrix.device_port }}..."
          
          chmod +x tools/flash_esp32_idf.sh
          ./tools/flash_esp32_idf.sh \
            --project ${{ matrix.project_dir }} \
            --port ${{ matrix.device_port }} \
            --log-dir logs/${{ matrix.target_code }} \
            || (echo "::error::Flash failed for ${{ matrix.target }}" && exit 1)
      
      - name: Wait for device boot
        run: |
          echo "Waiting for device to boot and stabilize..."
          sleep 7
      
      - name: Validate serial boot contract
        timeout-minutes: 2
        run: |
          echo "Validating serial boot contract..."
          chmod +x tools/serial_watch.py
          
          python tools/serial_watch.py \
            --port ${{ matrix.device_port }} \
            --timeout ${{ env.BOOT_TIMEOUT }} \
            --expect '"selftest":"pass"' \
            --log-dir logs/${{ matrix.target_code }} \
            || (echo "::error::Boot contract validation failed for ${{ matrix.target }}" && exit 1)
          
          echo "✅ Serial boot contract validated"
      
      - name: Validate MQTT status
        timeout-minutes: 2
        run: |
          echo "Validating MQTT status message..."
          chmod +x tools/mqtt_check.py
          
          python tools/mqtt_check.py \
            --broker ${{ env.MQTT_BROKER }} \
            --port ${{ env.MQTT_PORT }} \
            --topic "lab/+/status" \
            --timeout ${{ env.MQTT_TIMEOUT }} \
            --expect '"selftest":"pass"' \
            --log-dir logs/${{ matrix.target_code }} \
            || (echo "::error::MQTT validation failed for ${{ matrix.target }}" && exit 1)
          
          echo "✅ MQTT status validated"
      
      - name: Generate test report
        if: always()
        run: |
          REPORT_FILE="logs/${{ matrix.target_code }}/test-report.txt"
          
          cat > "$REPORT_FILE" << EOF
          ========================================
          HIL Test Report: ${{ matrix.target }}
          ========================================
          Target:        ${{ matrix.target }}
          Platform:      ${{ matrix.platform }}
          Device Port:   ${{ matrix.device_port }}
          
          Git SHA:       ${{ steps.git_info.outputs.sha_full }}
          Short SHA:     ${{ steps.git_info.outputs.sha_short }}
          
          Test Date:     $(date -u +"%Y-%m-%d")
          Test Time:     $(date -u +"%H:%M:%S UTC")
          Workflow:      ${{ github.workflow }}
          Run Number:    ${{ github.run_number }}
          
          Status:        ${{ job.status }}
          ========================================
          EOF
          
          cat "$REPORT_FILE"
      
      - name: Upload test logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hil-logs-${{ matrix.target_code }}-${{ steps.git_info.outputs.sha_short }}
          path: logs/${{ matrix.target_code }}/
          retention-days: 14
      
      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const target = '${{ matrix.target }}';
            const sha = '${{ steps.git_info.outputs.sha_short }}';
            
            const comment = `### ${status} HIL Test: ${target}
            
            - **Commit**: \`${sha}\`
            - **Status**: ${status === '✅' ? 'Passed' : 'Failed'}
            - **Device**: ${{ matrix.device_port }}
            
            <details>
            <summary>Test Details</summary>
            
            - Platform: ${{ matrix.platform }}
            - Boot timeout: ${{ env.BOOT_TIMEOUT }}s
            - MQTT timeout: ${{ env.MQTT_TIMEOUT }}s
            
            </details>
            `;
            
            // Only post if this is the first matrix job to avoid spam
            // In a real scenario, you'd aggregate all results

  hil_summary:
    name: HIL Test Summary
    runs-on: [self-hosted, linux, x64, hil]
    needs: [hil_test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## HIL Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.hil_test.result }}" == "success" ]; then
            echo "✅ **All HIL tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some HIL tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "- **ESP32-S3**: ${{ needs.hil_test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CYD**: ${{ needs.hil_test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ESP32-P4**: Skipped (hardware not available)" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if tests failed
        if: needs.hil_test.result != 'success'
        run: |
          echo "::error::One or more HIL tests failed"
          exit 1
