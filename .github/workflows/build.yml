# Build Workflow
# Builds all firmware targets on self-hosted runner
#
# Triggers: PR and push to main
# Runner: ZimaBlade #1 (build runner)

name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: '3.11'
  PIO_VERSION: '6.1.15'

jobs:
  pio_build:
    name: Build ${{ matrix.target }}
    runs-on: [self-hosted, linux, x64, build]
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: ESP32-S3
            project_dir: firmware/esp32_s3_pio
            env_name: s3dev
            artifact_name: esp32-s3-firmware
            platform: platformio
          - target: CYD
            project_dir: firmware/cyd_pio
            env_name: cyd
            artifact_name: cyd-firmware
            platform: platformio
    
    outputs:
      git_sha_short: ${{ steps.git_info.outputs.sha_short }}
      git_sha_full: ${{ steps.git_info.outputs.sha_full }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            ${{ matrix.project_dir }}/.pio
          key: ${{ runner.os }}-pio-${{ matrix.target }}-${{ hashFiles(format('{0}/platformio.ini', matrix.project_dir)) }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.target }}-
            ${{ runner.os }}-pio-
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio==${{ env.PIO_VERSION }}
      
      - name: Get Git commit info
        id: git_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u +%H%M%S)" >> $GITHUB_OUTPUT
          
          # Try to get version from git tags
          if git describe --tags --exact-match 2>/dev/null; then
            echo "version=$(git describe --tags --exact-match)" >> $GITHUB_OUTPUT
          else
            echo "version=$(git describe --tags --always)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create secrets.h from template
        run: |
          cp ${{ matrix.project_dir }}/include/secrets.h.template \
             ${{ matrix.project_dir }}/include/secrets.h
          
          # Inject build metadata into secrets.h
          cat >> ${{ matrix.project_dir }}/include/secrets.h << EOF
          
          // Build metadata (auto-generated by CI)
          #ifndef BUILD_GIT_SHA
          #define BUILD_GIT_SHA "${{ steps.git_info.outputs.sha_short }}"
          #endif
          
          #ifndef BUILD_TIMESTAMP
          #define BUILD_TIMESTAMP ${{ steps.git_info.outputs.build_date }}${{ steps.git_info.outputs.build_time }}
          #endif
          
          #ifndef BUILD_VERSION
          #define BUILD_VERSION "${{ steps.git_info.outputs.version }}"
          #endif
          
          #ifndef BUILD_TARGET
          #define BUILD_TARGET "${{ matrix.target }}"
          #endif
          EOF
      
      - name: Build firmware
        run: |
          pio run -d ${{ matrix.project_dir }} -e ${{ matrix.env_name }} -v
      
      - name: Generate build manifest
        run: |
          BUILD_DIR="${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}"
          
          # Get binary sizes
          BIN_SIZE=$(stat -c%s "$BUILD_DIR/firmware.bin" 2>/dev/null || echo "0")
          ELF_SIZE=$(stat -c%s "$BUILD_DIR/firmware.elf" 2>/dev/null || echo "0")
          
          # Create build manifest
          cat > "$BUILD_DIR/build-manifest.json" << EOF
          {
            "target": "${{ matrix.target }}",
            "environment": "${{ matrix.env_name }}",
            "platform": "${{ matrix.platform }}",
            "git": {
              "sha": "${{ steps.git_info.outputs.sha_full }}",
              "sha_short": "${{ steps.git_info.outputs.sha_short }}",
              "branch": "${{ steps.git_info.outputs.branch }}",
              "version": "${{ steps.git_info.outputs.version }}"
            },
            "build": {
              "date": "${{ steps.git_info.outputs.build_date }}",
              "time": "${{ steps.git_info.outputs.build_time }}",
              "workflow": "${{ github.workflow }}",
              "run_number": ${{ github.run_number }},
              "run_id": "${{ github.run_id }}"
            },
            "artifacts": {
              "firmware_bin": {
                "name": "firmware.bin",
                "size_bytes": $BIN_SIZE
              },
              "firmware_elf": {
                "name": "firmware.elf",
                "size_bytes": $ELF_SIZE
              }
            }
          }
          EOF
          
          # Human-readable build info
          cat > "$BUILD_DIR/build-info.txt" << EOF
          ========================================
          Rack Controller Firmware Build
          ========================================
          Target:        ${{ matrix.target }}
          Environment:   ${{ matrix.env_name }}
          Platform:      ${{ matrix.platform }}
          
          Git SHA:       ${{ steps.git_info.outputs.sha_full }}
          Short SHA:     ${{ steps.git_info.outputs.sha_short }}
          Branch:        ${{ steps.git_info.outputs.branch }}
          Version:       ${{ steps.git_info.outputs.version }}
          
          Build Date:    $(date -u +"%Y-%m-%d")
          Build Time:    $(date -u +"%H:%M:%S UTC")
          Workflow:      ${{ github.workflow }}
          Run Number:    ${{ github.run_number }}
          
          Binary Size:   $(numfmt --to=iec-i --suffix=B $BIN_SIZE)
          ELF Size:      $(numfmt --to=iec-i --suffix=B $ELF_SIZE)
          ========================================
          EOF
          
          # Display build info
          cat "$BUILD_DIR/build-info.txt"
      
      - name: Analyze firmware size
        run: |
          BUILD_DIR="${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}"
          
          echo "ðŸ“¦ Firmware Binary Size:"
          ls -lh "$BUILD_DIR/firmware.bin"
          
          # Try to get memory usage from PlatformIO
          if [ -f "$BUILD_DIR/firmware.elf" ]; then
            echo ""
            echo "ðŸ” Memory Sections:"
            pio run -d ${{ matrix.project_dir }} -e ${{ matrix.env_name }} -t size 2>/dev/null || true
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.git_info.outputs.sha_short }}
          path: |
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/firmware.bin
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/firmware.elf
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/partitions.bin
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/bootloader.bin
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/build-manifest.json
            ${{ matrix.project_dir }}/.pio/build/${{ matrix.env_name }}/build-info.txt
          retention-days: 30
          if-no-files-found: error

  idf_build_p4:
    name: Build ESP32-P4 (ESP-IDF)
    runs-on: [self-hosted, linux, x64, build]
    if: false  # Skip until P4 hardware is available
    
    container:
      image: espressif/idf:v5.3
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get Git commit info
        id: git_info
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "version=$(git describe --tags --always)" >> $GITHUB_OUTPUT
      
      - name: Configure build metadata
        run: |
          cd firmware/esp32_p4_idf
          
          # Create a version header
          mkdir -p components/version/include
          cat > components/version/include/version.h << EOF
          #ifndef VERSION_H
          #define VERSION_H
          
          #define BUILD_GIT_SHA "${{ steps.git_info.outputs.sha_short }}"
          #define BUILD_TIMESTAMP $(date +%s)
          #define BUILD_VERSION "${{ steps.git_info.outputs.version }}"
          
          #endif
          EOF
      
      - name: Build ESP32-P4 firmware
        run: |
          . $IDF_PATH/export.sh
          cd firmware/esp32_p4_idf
          idf.py set-target esp32p4
          idf.py build
      
      - name: Generate build manifest
        run: |
          cd firmware/esp32_p4_idf/build
          
          cat > build-manifest.json << EOF
          {
            "target": "ESP32-P4",
            "platform": "esp-idf",
            "git": {
              "sha": "${{ steps.git_info.outputs.sha_full }}",
              "sha_short": "${{ steps.git_info.outputs.sha_short }}",
              "version": "${{ steps.git_info.outputs.version }}"
            },
            "build": {
              "date": "$(date -u +%Y%m%d)",
              "time": "$(date -u +%H%M%S)",
              "workflow": "${{ github.workflow }}",
              "run_number": ${{ github.run_number }}
            }
          }
          EOF
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-p4-firmware-${{ steps.git_info.outputs.sha_short }}
          path: |
            firmware/esp32_p4_idf/build/*.bin
            firmware/esp32_p4_idf/build/*.elf
            firmware/esp32_p4_idf/build/build-manifest.json
          retention-days: 30

  build_summary:
    name: Build Summary
    runs-on: [self-hosted, linux, x64, build]
    needs: [pio_build]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.pio_build.result }}" == "success" ]; then
            echo "âœ… **PlatformIO Builds**: Success" >> $GITHUB_STEP_SUMMARY
            echo "- Git SHA: \`${{ needs.pio_build.outputs.git_sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **PlatformIO Builds**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- HIL tests will run on PR" >> $GITHUB_STEP_SUMMARY
          echo "- Manual deployment via \`release_flash.yml\` workflow" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if builds failed
        if: needs.pio_build.result != 'success'
        run: |
          echo "::error::One or more builds failed"
          exit 1
