# Auto-create GitHub Issue on HIL Failure
# Creates structured issues for AI-assisted debugging
#
# Triggers: When HIL workflow completes with failure

name: Create Issue on Failure

on:
  workflow_run:
    workflows: ["HIL Tests"]
    types:
      - completed

jobs:
  create_issue:
    name: Create Failure Issue
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    permissions:
      issues: write
      actions: read

    steps:
      - name: Create issue with failed job details
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            const jobsResp = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id
            });

            const failedJobs = jobsResp.data.jobs
              .filter(job => job.conclusion === 'failure')
              .map(job => job.name);

            const failedJobsList = failedJobs.length
              ? failedJobs.map(j => `- ${j}`).join('\n')
              : '- Unknown (check workflow run)';

            const issueBody = `
            ## HIL Test Failure Report

            A Hardware-in-the-Loop test has failed and requires investigation.

            ### Failure Details

            | Field | Value |
            |-------|-------|
            | **Workflow Run** | [#${run.id}](${run.html_url}) |
            | **Commit** | \`${run.head_sha}\` |
            | **Branch** | \`${run.head_branch}\` |
            | **Triggered by** | @${run.actor?.login || 'unknown'} |
            | **Event** | \`${run.event}\` |

            ### Failed Jobs

            ${failedJobsList}

            ### Logs

            Check the workflow run for logs and artifacts:
            ${run.html_url}

            ---

            ### Instructions for AI Fix

            1. Open the workflow run and download any uploaded artifacts (logs/*).
            2. Classify the failure:
               - Build failure: compiler/toolchain errors
               - Flash failure: device port/permissions/USB stability
               - Serial contract failure: JSON not printed or mismatched
               - MQTT failure: broker/DNS/network
            3. Implement the minimal fix and open a PR that references this issue.
            4. Confirm HIL is green on the PR.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CI] HIL Test Failure - ${run.head_sha.substring(0, 7)}`,
              body: issueBody,
              labels: ['ci-failure', 'ai-fix-needed']
            });

            console.log('Issue created successfully');
